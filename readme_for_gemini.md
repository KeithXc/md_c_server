# Project Context for Gemini

This file provides a quick overview of the "C Markdown Blog" project for Gemini to ensure a smooth continuation of our work in future sessions.

## 1. Project Goal

The primary goal of this project is to create a simple, lightweight, and fast web server entirely in C. Its sole purpose is to find Markdown files (`.md`) in a specific directory, convert them to HTML on the fly, and serve them to a web browser.

## 2. Core Technologies

-   **Language**: C (std=c11)
-   **Build System**: CMake (configured to automatically find all source files in `src/`)
-   **Core Libraries**:
    -   `mongoose`: An embedded web server library for handling HTTP requests.
    -   `cmark`: A library for parsing Markdown and converting it to HTML.
    -   `zlib`: For Gzip compression of HTTP responses.

## 3. Directory Structure

The project is organized into the following directories:

-   `bin/`: **Output** for the final compiled `md_c_server` executable. (Ignored by Git)
-   `build/`: **Temporary files** generated by CMake and the compiler. (Ignored by Git)
-   `cache/`: **Cached data** for compressed HTML responses. (Ignored by Git)
-   `md/`: **Content** directory where user places their `.md` files.
-   `src/`: **Source code** directory.
    -   `server.c`: Handles server initialization, socket listening, and routing.
    -   `routes_*.c`/`.h`: Contain logic for specific routes (`/` and `/post/*`).
    -   `cache.c`/`.h`: Implements the caching and Gzip compression logic.
    -   `utils.c`/`.h`: Provides shared utility functions.
    -   `mongoose.c`/`.h`: The Mongoose library source files.
-   `templates/`: HTML templates.

## 4. Current Status & Features

1.  **Markdown to HTML**: Converts `.md` files to HTML on the fly using `cmark`.
2.  **Gzip Compression**: Compresses all HTML responses with `zlib` before sending.
3.  **Full Caching Support**:
    -   **Posts & Index**: Both post pages and the main index page support `ETag` and `Last-Modified` headers.
    -   **Conditional Requests**: The server correctly handles `If-None-Match` and `If-Modified-Since` headers, returning a `304 Not Modified` response for unchanged content to save bandwidth.
    -   **File-based Cache**: Generated content is cached in the `cache/` directory to reduce CPU load on subsequent requests. The cache is automatically invalidated if source files are modified.
4.  **Dynamic File Tree**:
    -   The homepage (`/`) dynamically generates a file tree based on the contents of the `md/` directory.
    -   Directory listings are now interactive and default to an expanded (open) state.
    -   The default list item bullets have been removed via CSS for a cleaner look, leaving only the interactive disclosure triangles.
5.  **Robust Control Scripts**: `run.sh` now ensures a clean build and restart by clearing cache and killing any old "zombie" server processes before compiling and running. `stop.sh` reliably terminates all server processes.

## 5. How to Build and Run

Use the provided shell scripts:
-   **Start server**: `./run.sh`
-   **Stop server**: `./stop.sh`

The server will be accessible at `http://localhost:8000`.

## 6. Gemini's Debugging Workflow Examples

### Example 1: The Double `Content-Length` Header

We previously debugged an issue where browser tabs would spin indefinitely.

1.  **Problem**: Browser tab stuck in a loading state.
2.  **Verification**: `curl -v` showed the server was sending **two** `Content-Length` headers. This was caused by misusing `mg_http_reply`.
3.  **Solution**: We switched to manually constructing the header block and sending it with `mg_printf`, then setting `c->is_draining = 1` to gracefully close the connection.
4.  **Takeaway**: `curl -v` is invaluable for inspecting raw server responses.

### Example 2: The Phantom `Content-Length: %zu` Bug

We fixed a bug where `curl` and `wget` reported an `Invalid Content-Length` header.

1.  **Problem**: `curl` and `wget` showed the server was literally sending `Content-Length: %zu`.
2.  **Root Cause**: The issue was traced to unreliable server restarts, where old "zombie" processes were not being killed by the `stop.sh` script. We were sending test requests to old, buggy server instances.
3.  **Solution**:
    a.  Killed all zombie processes using `pkill`.
    b.  Made the `stop.sh` script robust by switching it to `pkill`.
    c.  Modified `run.sh` to call `stop.sh` at the beginning, ensuring a clean state for every run.
4.  **Takeaway**: If code changes seem to have no effect, rigorously investigate the build and execution process.

### Example 3: The Impossible Template Bug (Memory Corruption)

We debugged a baffling issue where the homepage rendered with a raw `{{FILE_LIST}}` placeholder instead of the file tree.

1.  **Problem**: The `str_replace` function was failing to replace the placeholder, even though `git diff` and `xxd` confirmed the placeholder strings in the C code and the HTML template were identical. The server was also crashing intermittently.
2.  **Initial Hypothesis**: A bug in the file listing recursion or a subtle issue with the template file (e.g., hidden characters). These were ruled out by simplifying the code and inspecting the template's hex dump.
3.  **Root Cause Analysis**: The illogical behavior of `strstr` failing pointed towards memory corruption. A detailed code review revealed a classic **off-by-one error** in the `append_string` helper function. The check `current_len + str_len >= *capacity` did not account for the final null terminator, allowing `strcat` to write one byte out of bounds. This corrupted the memory heap, which coincidentally damaged the `template_content` string before it could be used, causing `strstr` to fail.
4.  **Solution**: The condition in `append_string` was corrected to `current_len + str_len + 1 > *capacity`. This resolved both the server crashes and the template replacement failure.
5.  **Takeaway**: When a standard library function like `strstr` appears to fail for no logical reason, suspect memory corruption. Carefully review all manual memory management, buffer allocations (`realloc`), and string operations (`strcat`, `strcpy`) for potential off-by-one or buffer overflow errors.